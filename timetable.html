<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>School Timetable Countdown — Felix</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Mono&display=swap" rel="stylesheet">
<style>
    :root{
        --card-bg: rgba(255,255,255,0.06);
        --glass: rgba(255,255,255,0.06);
        --muted: #9aa4b2;
        --accent: #5cc1ff;
        --accent-2: #7b61ff;
        --card-radius: 14px;
        --shadow: 0 10px 30px rgba(12,18,30,0.45);
        --settings-bg: rgba(3,12,20,0.95); /* solid-ish dark background for settings */
        --settings-border: rgba(255,255,255,0.06);
    }

    html,body{
        height:100%;
        margin:0;
        background: linear-gradient(160deg,#0f1724 0%, #071226 45%, #021017 100%);
        color: #e6eef8;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        -webkit-font-smoothing:antialiased;
        -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
        min-height:100%;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:32px;
        box-sizing:border-box;
    }

    .card{
        width:100%;
        max-width:980px;
        background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
        border-radius: var(--card-radius);
        box-shadow: var(--shadow);
        padding:22px;
        position:relative;
        overflow:hidden;
        backdrop-filter: blur(8px) saturate(120%);
        border: 1px solid rgba(255,255,255,0.04);
    }

    /* Top bar */
    .topbar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:16px;
    }

    .left-controls{
        display:flex;
        align-items:center;
        gap:10px;
    }

    .clock{
        font-family: "Space Mono", monospace;
        font-size: 2.2rem;
        font-weight:700;
        letter-spacing:0.5px;
        color: #ffffff;
        background: linear-gradient(90deg,var(--accent),var(--accent-2));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .small{
        font-size:0.88rem;
        color: var(--muted);
    }

    .controls{
        display:flex;
        align-items:center;
        gap:8px;
    }

    .btn{
        background: transparent;
        border: 1px solid rgba(255,255,255,0.06);
        color: #eaf6ff;
        padding:8px 12px;
        border-radius:10px;
        cursor:pointer;
        font-weight:600;
        font-size:0.9rem;
        display:inline-flex;
        align-items:center;
        gap:8px;
        transition: all .18s ease;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
    .btn.ghost{
        background: rgba(255,255,255,0.02);
        border:1px solid rgba(255,255,255,0.03);
    }

    .week-buttons button{
        min-width:40px;
        padding:8px 14px;
        border-radius:8px;
        border:1px solid rgba(255,255,255,0.04);
        background: rgba(255,255,255,0.02);
        color: #eaf6ff;
        font-weight:700;
    }
    .week-buttons button.active{
        background: linear-gradient(90deg,var(--accent),var(--accent-2));
        color: #021017;
        border-color: transparent;
    }

    /* Main area */
    .main-grid{
        display:grid;
        grid-template-columns: 1fr 320px;
        gap:22px;
        align-items:start;
    }

    .primary{
        padding:18px;
        border-radius:12px;
        background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
        border:1px solid rgba(255,255,255,0.03);
    }

    #main-line{
        font-size:1.8rem;
        font-weight:700;
        color:#ffffff;
        margin:0 0 8px 0;
        line-height:1.05;
    }

    #sub-line{
        color: var(--muted);
        font-size:1.05rem;
        margin:0 0 14px 0;
    }

    .meta{
        display:flex;
        align-items:center;
        gap:12px;
        color:var(--muted);
        font-size:0.95rem;
    }

    .pip-preview{
        position:relative;
        border-radius:12px;
        overflow:hidden;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
        padding:12px;
        display:flex;
        flex-direction:column;
        gap:12px;
        min-height:180px;
        justify-content:center;
        align-items:center;
        text-align:center;
    }

    .pip-preview canvas{
        max-width:100%;
        border-radius:8px;
        box-shadow: 0 6px 20px rgba(2,6,12,0.5) inset;
    }

    .settings-modal{
        position:fixed;
        right:20px;
        top:20px;
        width:360px;
        max-width:calc(100% - 40px);
        /* Solid higher-contrast background so text is readable */
        background-color: var(--settings-bg);
        border:1px solid var(--settings-border);
        border-radius:12px;
        padding:14px;
        box-shadow: 0 20px 40px rgba(1,6,12,0.6);
        z-index:2000;
        display:none;
        color: #eaf6ff;
    }
    .settings-modal.visible{ display:block; }
    .settings-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin:8px 0;
    }
    .checkbox{
        display:flex;
        align-items:center;
        gap:8px;
        color:#eaf6ff;
        font-weight:600;
    }
    .color-pair{
        display:flex;
        gap:8px;
        align-items:center;
    }
    input[type="color"]{
        width:44px;height:36px;border:none;padding:0;background:transparent;cursor:pointer;border-radius:8px;
        box-shadow: 0 4px 10px rgba(2,6,12,0.45);
    }

    /* small helper */
    .muted-block{ color:var(--muted); font-size:0.9rem; }

    /* responsive */
    @media (max-width:880px){
        .main-grid{ grid-template-columns: 1fr; }
        .pip-preview{ min-height:160px; }
    }
</style>
</head>
<body>

<div class="wrap">
    <div class="card" role="application" aria-label="School timetable countdown">
        <div class="topbar">
            <div class="left-controls">
                <div>
                    <div class="clock" id="clock">--:--:--</div>
                    <div class="small muted-block" id="todayLabel">Loading…</div>
                </div>
            </div>

            <div class="controls">
                <div class="week-buttons" role="tablist" aria-label="Week toggle">
                    <button id="weekA" class="btn ghost" aria-pressed="false">Week A</button>
                    <button id="weekB" class="btn ghost" aria-pressed="false">Week B</button>
                </div>
                <button id="settingsBtn" class="btn" title="PiP and appearance settings">⚙ Settings</button>
            </div>
        </div>

        <div class="main-grid">
            <div class="primary" aria-live="polite">
                <div id="main-line">Loading...</div>
                <div id="sub-line"></div>
                <div class="meta" id="meta">
                    <div id="meta-day" class="muted-block">—</div>
                    <div id="meta-status" class="muted-block">—</div>
                </div>
            </div>

            <div class="pip-preview" aria-hidden="true">
                <div class="small">PiP Preview</div>
                <!-- visible but not capturing user camera; small canvas preview (16:9) -->
                <canvas id="previewCanvas" width="320" height="180" style="width:100%;max-width:320px;height:auto;border-radius:8px;"></canvas>
                <div class="small muted-block">Click anywhere on the page to enter Picture-in-Picture (if supported)</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden video used for PiP streaming -->
<video id="pipVideo" muted autoplay playsinline style="width:1px;height:1px;opacity:0;position:fixed;pointer-events:none;left:-9999px;top:-9999px;"></video>

<!-- Settings panel (floating) -->
<div id="settingsModal" class="settings-modal" role="dialog" aria-modal="false" aria-label="PiP settings">
    <h3 style="margin:0 0 6px 0;color:#eaf6ff;">PiP Settings</h3>
    <div class="small muted-block" style="margin-bottom:12px;">Choose what the PiP shows and the gradient colours. Settings are saved locally.</div>

    <div class="settings-row">
        <label class="checkbox"><input id="includeMain" type="checkbox" /> Show main line</label>
        <label class="checkbox"><input id="includeSub" type="checkbox" /> Show sub line</label>
    </div>
    <div class="settings-row">
        <label class="checkbox"><input id="includeTime" type="checkbox" /> Show current time</label>
        <label class="checkbox"><input id="includeFooter" type="checkbox" /> Show footer</label>
    </div>

    <div style="height:8px"></div>

    <div class="settings-row" style="flex-direction:column;align-items:stretch;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="small muted-block">PiP gradient colours</div>
            <div style="display:flex;gap:8px;">
                <input id="pipTopColor" type="color" title="Top color" />
                <input id="pipBottomColor" type="color" title="Bottom color" />
            </div>
        </div>
        <div style="margin-top:8px;font-size:0.85rem;color:var(--muted);">Tip: use contrasting colours for readable white text overlay.</div>
    </div>

    <div style="height:12px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="closeSettings" class="btn ghost">Close</button>
        <button id="saveSettings" class="btn">Save</button>
    </div>
</div>

<script>
// ---------- CONFIG (single TIMES object, include all referenced keys) ----------
const TIMES = {
    form:      { start: "08:30", end: "08:35" },
    formA:     { start: "08:30", end: "08:35" },
    formB:     { start: "13:50", end: "14:10" },

    p1:        { start: "08:40", end: "09:25" },
    p2:        { start: "09:30", end: "10:15" },
    p3:        { start: "10:20", end: "11:05" },
    break:     { start: "11:05", end: "11:20" },
    p4:        { start: "11:25", end: "12:10" },
    p5:        { start: "12:15", end: "13:00" },
    lunch:     { start: "13:00", end: "13:45" },
    lunchA:    { start: "13:00", end: "13:45" },
    lunchB:    { start: "13:00", end: "13:15" },
    lunchC:    { start: "13:30", end: "13:45" },
    lunchD:    { start: "13:00", end: "13:25" },

    MT:        { start: "13:15", end: "13:45" },
    MB:        { start: "13:00", end: "13:30" },
    ML:        { start: "13:15", end: "13:45" },
    FS:        { start: "13:25", end: "13:50" },

    p6:        { start: "14:15", end: "15:00" },
    p7:        { start: "15:05", end: "15:50" },
    activity:  { start: "15:50", end: "16:40" },
    longAct:   { start: "15:50", end: "17:30" }
};

// ---------- TIMETABLE (unchanged) ----------
const TIMETABLE = {
    A: {
        1: [
            {type:"formA",label:"Form Time - Somerville IT"},
            {type:"p1",label:"Music - Music Technology Suite"},
            {type:"p2",label:"French - Chaucer 1"},
            {type:"p3",label:"Global Perspectives - Brake 4"},
            {type:"break",label:"Break"},
            {type:"p4",label:"Computer Science - Somerville IT"},
            {type:"p5",label:"English - Coronation 13"},
            {type:"lunchB",label:"Lunch - 13:00"},
            {type:"MT",label:"Music Theory - Music Technology Suite"},
            {type:"formB",label:"Form Time - Somerville IT"},
            {type:"p6",label:"Physics - Jubilee 12"},
            {type:"p7",label:"French - Chaucer 1"},
            {type:"activity",label:"Composition - Music Technology Suite"}
        ],
        2: [
            {type:"formA",label:"_Form truncated for brevity in query"}]}